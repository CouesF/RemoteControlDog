# 摄像头连接调试功能总结

## 概述
为了解决前端显示"未连接摄像头"的问题，我们在前端添加了详细的摄像头连接调试功能。

## 新增文件

### 1. CameraConnectionDebugger.js
- **路径**: `src/renderer/js/components/CameraConnectionDebugger.js`
- **功能**: 摄像头连接调试器组件
- **特性**:
  - 实时显示UDP连接状态
  - 显示摄像头网关连接信息
  - 提供手动连接/断开功能
  - 显示详细的错误信息和日志
  - 测试摄像头数据接收
  - 显示连接统计信息

### 2. 测试页面
- **路径**: `camera_debug_test.html`
- **功能**: 独立的调试器测试页面
- **用途**: 可以在浏览器中直接测试调试器功能

## 修改的文件

### 1. map_builder.html
- 添加了摄像头连接调试区域
- 在摄像头监控区域之前显示调试信息

### 2. MapBuilder.js
- 已经集成了CameraConnectionDebugger组件
- 在`initializeComponents()`方法中初始化调试器

### 3. UDPConnectionManager.js
- 修复了API调用兼容性问题
- 支持新旧两种API命名方式：
  - `connectUDP` / `connect-udp`
  - `disconnectUDP` / `disconnect-udp`
  - `sendUDPMessage` / `send-udp-message`

### 4. main.css
- 添加了调试器相关的CSS样式
- 包括`.camera-debug-section`和`.camera-debug-container`

## 调试器功能详解

### 连接状态监控
- **UDP连接状态**: 显示与后端UDP服务的连接状态
- **摄像头网关状态**: 显示与摄像头网关的连接状态
- **实时更新**: 状态变化时自动更新显示

### 连接测试
- **手动连接**: 提供按钮手动触发连接
- **连接测试**: 发送测试消息验证连接
- **断开连接**: 手动断开连接进行测试

### 错误诊断
- **详细错误信息**: 显示具体的错误消息
- **连接日志**: 记录连接过程中的所有事件
- **网络配置显示**: 显示当前的网络配置信息

### 数据监控
- **消息统计**: 显示发送/接收的消息数量
- **延迟监控**: 显示连接延迟信息
- **数据流状态**: 监控摄像头数据流

## 网络配置

### 当前配置
```javascript
camera: {
    host: '118.31.58.101',
    port: 48991,
    localPort: 8991,
    type: 'camera',
    autoReconnect: true
}
```

### FRP配置
- **后端端口**: 8991
- **公网端口**: 48991
- **公网IP**: 118.31.58.101

## 使用方法

### 1. 在地图构建页面
1. 打开地图构建页面
2. 查看"摄像头连接调试"区域
3. 观察连接状态和错误信息
4. 使用手动连接按钮进行测试

### 2. 独立测试页面
1. 在浏览器中打开 `camera_debug_test.html`
2. 查看调试器功能
3. 测试各种连接场景

## 故障排除步骤

### 1. 检查UDP连接
- 查看调试器中的UDP连接状态
- 确认是否能连接到 `118.31.58.101:48991`

### 2. 检查后端服务
- 确认camera_gateway服务正在运行
- 检查端口8991是否被正确监听

### 3. 检查FRP配置
- 确认FRP正确转发48991到8991端口
- 检查防火墙设置

### 4. 检查网络连接
- 测试到公网IP的连通性
- 确认UDP包能正常传输

## 调试信息解读

### 连接状态
- **已连接**: UDP连接建立成功
- **连接中**: 正在尝试建立连接
- **已断开**: 连接已断开
- **连接失败**: 连接建立失败

### 错误类型
- **网络错误**: 无法连接到指定地址
- **超时错误**: 连接超时
- **协议错误**: 数据格式不正确
- **服务错误**: 后端服务异常

## 下一步建议

1. **运行调试器**: 首先在地图构建页面查看调试信息
2. **检查后端**: 确认camera_gateway服务状态
3. **网络测试**: 使用调试器测试网络连接
4. **日志分析**: 查看详细的连接日志
5. **逐步排查**: 从UDP连接开始，逐步检查各个环节

## 技术细节

### API兼容性
调试器支持两种API命名方式，确保与不同版本的主进程兼容：
- 新版本: `connectUDP`, `disconnectUDP`, `sendUDPMessage`
- 旧版本: `connect-udp`, `disconnect-udp`, `send-udp-message`

### 错误处理
- 所有网络操作都有完整的错误处理
- 错误信息会显示在调试界面中
- 支持自动重连机制

### 状态管理
- 使用事件驱动的状态更新
- 实时反映连接状态变化
- 支持手动刷新状态

这个调试系统应该能帮助您快速定位摄像头连接问题的根本原因。
